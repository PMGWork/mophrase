# MoPhrase AI用語集

このドキュメントは、MoPhrase に関わる用語を AI が一貫して解釈するための共通辞書です。

## 1. 目的

- 自然言語の編集意図を、空間編集と時間編集に正しくマッピングする。
- JSON 入出力の語彙ゆれを減らし、スキーマ不整合を防ぐ。
- 「手描きらしさを残す」という MoPhrase の方針を、用語レベルで固定する。

## 2. コア概念（論文由来）

| 用語 | 定義 | AIが取るべき行動 |
| --- | --- | --- |
| モーションパス | オブジェクトの空間的な移動軌跡 | 形状編集は `x/y` と `sketchIn/out` を主に変更 |
| イージング曲線 | 時間に対する進行度の変化（緩急） | タイミング編集は `graphIn/out` を主に変更 |
| 局所編集 | ユーザ選択区間のみを補正 | 非選択区間を過剰に変更しない |
| セマンティック編集 | 「ふわっと」「キレよく」等の言語的意図を反映 | 語感を空間/時間パラメータへ翻訳 |
| 補正案 | LLM が返す候補 | 3案を明確に差別化して返す |
| モディファイア | 補正差分を保持する編集単位 | 破壊的上書きではなく差分適用を前提にする |

## 3. データモデル用語（実装由来）

| 用語 | 型/場所 | 定義 |
| --- | --- | --- |
| `Keyframe` | `src/types.ts` | 時刻 `time` と位置 `position`、およびハンドルを持つ節点。配列インデックスで識別 |
| `sketchIn` / `sketchOut` | `Keyframe` | 空間ベジェの入出ハンドル（アンカー相対ベクトル） |
| `graphIn` / `graphOut` | `Keyframe` | 時間カーブの入出ハンドル（時間-進行度平面のベクトル） |
| `SerializedKeyframe` | `src/types.ts` | LLM 通信用の正規化キーフレーム |
| `SerializedHandle` | `src/types.ts` | `angle` と `dist` で表現される極座標ハンドル |
| `SerializedPath` | `src/types.ts` | `keyframes` + `bbox` の LLM 通信用パス |
| `Suggestion` | `src/types.ts` | UI表示用の提案（`id`, `title`, `path`） |
| `Modifier` | `src/types.ts` | `SketchModifier \| GraphModifier` の共通型エイリアス |
| `SketchModifier` | `src/types.ts` | 空間ベジェ差分をキーフレーム単位で保持する編集単位 |
| `GraphModifier` | `src/types.ts` | 時間カーブ差分をキーフレーム単位で保持する編集単位 |

## 4. 座標・正規化ルール

| 対象 | 正規化方式 | 補足 |
| --- | --- | --- |
| `x`, `y` | `bbox` 基準で 0-1 付近に正規化 | 空間形状を表す |
| `time` | 0-1 正規化時間 | 実装上は単調増加に補正される |
| `sketchIn/out` | バウンディングボックス対角長で距離正規化 + 角度 | 極座標で扱う |
| `graphIn/out` | 区間の `(dt,dv)` 対角長で距離正規化 + 角度 | 時間カーブ編集に使う |

## 5. 重要な解釈ルール（AI向け）

1. 空間意図（形・位置・曲率）を受けたら `x/y/sketchIn/sketchOut` を優先編集する。
2. 時間意図（加速・減速・緩急）を受けたら `graphIn/graphOut` を優先編集する。
3. 両方の語感があるときのみ空間と時間を同時編集する。
4. `time` は原則維持し、並び順を壊さない。
5. キーフレーム数と接続順は維持する。
6. 数値はすべて有限値にする（`NaN`, `Infinity`, `undefined` を出さない）。
7. 過剰なクリーンアップを避け、手描きの揺らぎをデフォルトで保持する。

## 6. 語感から編集対象へのマッピング

| ユーザ表現 | 主編集対象 | 補助編集 |
| --- | --- | --- |
| ふわっと / 軽やか | `graphIn/out`（緩やかなイーズ） | `sketch` を少し丸める |
| キレよく / シャープ | `graphIn/out`（急加速・急停止） | 直線寄りにする |
| 弾む / バウンド | `graphIn/out`（オーバーシュート） | `y` 振幅や曲率を強める |
| なめらかに | `sketchIn/out` の接続連続性 | `graph` も過度な段差を抑える |
| 勢いよく | `graphIn/out` 優先 | 空間形状は大きく崩さない |
| ダイナミック | 空間と時間の両方 | 変化量は案ごとに幅を持たせる |

## 7. 語彙ゆれ対策（同義語の正規化）

| 入力語 | 正規化先 |
| --- | --- |
| 軌跡 / パス / 動線 | モーションパス |
| 緩急 / テンポ / ノリ | イージング曲線 |
| 区間 / 範囲 / セグメント | 局所編集区間 |
| 補正 / 修正 / 調整 | モディファイア適用 |
| ハンドル / 制御点ベクトル | `sketchIn/out` または `graphIn/out` |

## 8. 出力契約チェックリスト

- 提案数は 3 件固定。
- 各提案は単なるスケール違いではなく、編集方針そのものを変える。
- `keyframes.length` は入力と同一。
- 省略禁止フィールドは必ず埋める（`null` 可）。
- 非選択区間を暗黙に変更しない。

## 9. 実装メモ（不整合を防ぐための注意）

- 実装の `SerializedHandle` は `angle/dist` 形式。
- 論文説明では時間ハンドルを比率座標で説明している箇所があるが、現行コードでは極座標で扱う。
- AI 向け仕様を更新する際は、`src/types.ts` を唯一のスキーマ正として参照する。

## 10. 参照

- 論文: `/Users/yuto/Downloads/interaction2026_last.pdf`
- プロンプト: `src/prompts/keyframePrompt.md`
- 型: `src/types.ts`
- シリアライズ: `src/utils/serialization/curves.ts`
- 提案処理: `src/suggestion/suggestionService.ts`

# MoPhrase TODO

最終更新: 2026-02-26

## 未着手

- [x] モディファイア適用時の分割処理を実装する
  - 背景: 現在はモディファイア適用時に対象区間の分割が不十分で、局所編集時に意図しない影響範囲が出る可能性がある。
  - 対象候補: `src/utils/modifier.ts`, `src/utils/path.ts`, 適用呼び出し元（`src/core/motionManager.ts` など）
  - 方針メモ:
    - 適用対象のセグメント境界を明示的に分割する。
    - 非対象区間は不変に保ち、既存のキーフレーム順序・接続順を維持する。
    - 強度スライダでの再適用時に、分割結果が破綻しないことを確認する。
  - 完了条件:
    - 選択区間のみモディファイア影響が出る。
    - 選択外区間の形状・タイミングが維持される。
    - 既存のモディファイア適用フローで回帰がない。

- [ ] 補正提案のバリエーション品質を改善する（類似提案3件の発生を抑える）
  - 背景: 補正提案で3件がほぼ同一内容になることがあり、選択肢としての価値が下がっている。
  - 対象候補: `src/prompts/keyframePrompt.md`, 提案生成呼び出し箇所, 出力後処理ロジック
  - 方針メモ:
    - 提案間の差分軸（テンポ/強弱/軌道/スタイル）を明示し、重複を避ける指示にする。
    - 出力結果の類似度チェックを導入し、一定閾値を超えた提案は再生成または置換する。
  - 完了条件:
    - 同一入力に対して3件の提案が実質的に異なる。
    - 提案品質を落とさずに重複率を下げられる。

- [ ] 提案プロンプトを音声入力できるようにする
  - 背景: iPad/タブレット利用時にキーボード入力の負担が大きく、提案指示の試行回数が減りやすい。
  - 対象候補: `src/components/Suggestion.tsx`, `src/suggestion/suggestion.ts`, 入力まわりのUI/状態管理
  - 方針メモ:
    - Web Speech API（`SpeechRecognition`）を優先利用し、非対応ブラウザでは従来テキスト入力にフォールバックする。
    - マイクON/OFF状態、録音中表示、認識失敗時のリトライ導線を用意する。
    - 確定前にテキスト編集できるフローにして、誤認識をそのまま送信しない。
  - 完了条件:
    - 対応ブラウザで音声入力から提案送信まで完了できる。
    - 非対応ブラウザで既存入力フローが維持される。
    - 認識失敗/権限拒否時にUIが破綻せず復帰できる。

- [ ] フィッティング時に不連続点を考慮した補間/最適化を行う
  - 背景: フィッティング処理が連続性前提になっており、不連続を含むケースで意図しないつながりが発生する。
  - 対象候補: フィッティング処理本体, パス/セグメント前処理, エディタ適用時の境界処理
  - 方針メモ:
    - 速度・角度・距離変化などから不連続候補を検出し、区間を分けて扱う。
    - 不連続境界では補間制約を切り替え、不要なスムージングを回避する。
  - 完了条件:
    - 不連続を含む入力で境界付近の破綻が減る。
    - 連続入力では従来品質を維持する。

- [ ] スケッチ/グラフのモディファイアを自動判定する
  - 背景: 現状は明示選択に依存し、入力意図に合うモディファイア選択の手間が大きい。
  - 対象候補: `src/editor/sketchEditor/*`, `src/editor/graphEditor/*`, `src/utils/modifier.ts`, UI選択導線
  - 方針メモ:
    - 入力特徴（形状・時間変化・編集コンテキスト）から候補モディファイアを推定する。
    - 自動判定結果は提案として表示し、ユーザーが確定/上書きできるUIにする。
  - 完了条件:
    - 主要操作で適切なモディファイア候補が自動提示される。
    - 手動選択フローとの互換性を維持し、誤判定時も即座に修正できる。

- [x] iPad/PC両対応の入力基盤を整備する（Sketch/Graph）
  - 背景: 現状は `mousePressed/Dragged/Released` 中心で、デバイス差分の吸収が難しく、iPadのタッチ/ペン入力で描画・選択・編集がしづらい。
  - 対象候補: `src/components/Canvas.tsx`, `src/editor/sketchEditor/editor.ts`, `src/editor/graphEditor/editor.ts`, `src/utils/input.ts`
  - 方針メモ:
    - 入力取得を Pointer Events 基準に再整理し、マウス/タッチ/ペンを同一経路で処理する。
    - Pointer capture と `pointercancel` 処理を導入し、ドラッグ中断や誤入力に強くする。
    - スクロール・ピンチズームとの競合を避けるため、必要な `touch-action` を明示する。
    - 既存のPC操作（左クリック中心）とショートカット前提の挙動を維持する。
  - 完了条件:
    - iPad Safari で描画・選択・ハンドル編集・再生操作が可能である。
    - 意図しないページスクロールやジェスチャ競合が発生しない。
    - PC操作（マウス）で既存挙動の回帰がない。
    - Sketch/Graph両エディタで入力処理方針が統一される。

- [ ] iPad向けのプロジェクト保存/読込フォールバックを実装する
  - 背景: `showOpenFilePicker` / `showSaveFilePicker` 非対応環境では保存・読込ができず、iPad利用時の運用が止まる。
  - 対象候補: `src/hooks/useSketchEditor.ts`, 保存/読込UIまわり
  - 方針メモ:
    - 非対応時は JSON のエクスポート/インポート導線にフォールバックする。
    - 既存のプロジェクト名・未保存状態管理と整合を取る。
  - 完了条件:
    - iPad Safari で保存と読込の代替導線が利用できる。
    - 既存のPC保存/読込フローに回帰がない。

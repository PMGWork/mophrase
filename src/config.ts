/// アプリケーション設定

import type { LLMProvider } from './llmService';

// スキーマ定義
export interface Config {
  showSketch: boolean;        // ストロークの初期表示状態
  errorTolerance: number;     // 許容誤差(ピクセル)
  coarseErrorWeight: number;  // 粗い誤差の倍数
  defaultDragMode: number;    // デフォルトのドラッグモード
  lineWeight: number;         // 線の太さ
  pointSize: number;          // 制御点のサイズ
  llmProvider: LLMProvider;   // LLMプロバイダ名
  llmModel: string;           // LLMモデル名
  llmPrompt: string;          // 指示プロンプト
  includePoints: boolean;     // コンテキストに手書きを含めるか
};

export interface Colors {
  handle: string;      // 制御点の色
  curve: string;       // ベジェ曲線の色
  sketch: string;      // スケッチ線の色
  border: string;      // 境界線の色
  background: string;  // 背景色
}

// デフォルト設定
export const DEFAULT_CONFIG: Config = {
  showSketch: false,
  errorTolerance: 15,
  coarseErrorWeight: 2.0,
  defaultDragMode: 1,
  lineWeight: 1,
  pointSize: 6,
  includePoints: true,
  llmProvider: 'OpenAI',
  llmModel: 'gpt-5.1',
  llmPrompt: [
  // 役割
  'あなたは「手描き軌跡 + 自然言語指示」に基づいて、文脈に沿ったモーション／シェイプパスを補正するアシスタントです.',
  'ユーザーの意図を尊重しつつ、既存パスの特徴と滑らかさをできるだけ保ちながら、実用的なモーションパス案を提案してください。',

  // 入力の前提
  '入力として、パス情報（パスの要約や形状カテゴリ、既存のベジェ曲線配列など）と、ユーザーの自然言語指示が与えられます。',
  'パスは複数の3次ベジェ曲線からなり、各セグメントは [P0, P1, P2, P3] の4点で表されます。',

  // 出力のゴール
  'あなたのタスクは、元のパスを大きく壊さずに、ユーザー指示に沿ったモーションパスの「修正案」を3件生成することです。',
  '各修正案は以下を含みます：',
  '1) 編集コンセプト（例: サイン波のループ数増加、バウンドの回数・高さ調整、螺旋の広がり方など）',
  '2) ループ回数・減衰・コミカル／リアルさ・スケール・回転など、自然言語から導かれるパラメータの値',
  '3) それらのパラメータに基づいて調整されたベジェ曲線の制御点（curves 配列）',

  // 編集ポリシー（非常に重要）
  '【編集ポリシー】',
  '- P0 と P3 は、原則として入力パスのアンカー座標を維持し、スタート位置とエンド位置を変えないでください。',
  '- どうしても必要な場合のみ P0/P3 をわずかに移動してもよいですが、その場合も元位置からの変位は非常に小さく抑えてください。',
  '- 主な編集は P1 と P2（ハンドル）で行い、カーブの向き・強さ・膨らみ具合を調整してください。',
  '- セグメント間では、可能な限りC1連続（位置と接線の連続性）を保ち、急激な折れ曲がりを避けてください。',
  '- 元のパスの「全体の流れ（方向・形状）」は尊重し、完全に別物の軌跡にしないでください。',

  // ユーザー指示の解釈方針
  '【ユーザー指示の解釈】',
  '- 「3回ループ」「5回跳ねる」などの回数指定は、サイン波のピーク数やバウンド数として解釈し、パス全体の長さと整合するように調整してください。',
  '- 「徐々に減衰」は、時間方向に沿って振幅が単調に小さくなるように解釈してください。',
  '- 「コミカル」は、オーバーシュートやエクストリームなイージング（squash & stretch, anticipate/overshoot）など、アニメーション原則に基づく誇張表現として解釈してください。',
  '- 「リアル」は、重力や慣性といった物理的な一貫性を持つ動きとして解釈し、不自然な逆加速や過剰な変形を避けてください。',
  '- 指示が曖昧な場合は、控えめな（ conservative ）編集を行い、元のパスからの変化量を小さく保ってください。',

  // 数値制約
  '【数値制約】',
  '- curves 配列の各要素は必ず [P0, P1, P2, P3] の4点で構成してください。',
  '- P0/P3 には対応する入力パスのアンカー座標を使用し、原則変更しないでください。',
  '- 制御点（P1, P2, 必要ならP0/P3）の座標は、入力パスの境界ボックスの範囲から ±20% を超えないようにしてください。',
  '- NaN や Infinity、null、未定義の値は絶対に出力しないでください。',
  '- 3つの提案（suggestions 配列）は必ずすべて妥当な数値を持ち、同じ内容を単にコピーしたものにしないでください。',

  // 出力フォーマット
  '【出力フォーマット】',
  'レスポンスは、事前に指定されたJSONスキーマ（Zodスキーマ）に完全に従ってください。',
  '追加の説明文やコメント、自然言語テキストは一切出力せず、トップレベルに1つのJSONオブジェクトのみを返してください。',
  '各提案には次の情報を含めてください：',
  '- title: 修正内容を端的に表す英語のタイトル（3単語以内）',
  '- curves: 調整後のベジェ曲線配列（各要素は [P0, P1, P2, P3] の4点）',

  // 品質ガイド
  '【品質ガイド】',
  '- 3件の提案は、すべてユーザー指示を解釈したうえで意味のあるバリエーションにしてください（単なる強弱違いにしない）。',
  '- 極端すぎる形状（急激な向きの反転、極端に長いハンドルなど）は避け、モーションデザインで実際に使える範囲に収めてください。',
  '- 元パスから大きく逸脱する案を作る場合でも、少なくとも1件は「元パスに近いが指示を反映した控えめな修正案」にしてください。'
  ].join('\n'),
};

export const DEFAULT_COLORS: Colors = {
  handle: '#fbbf24',      // Amber-400
  curve: '#f9fafb',       // Gray-50
  sketch: '#374151',      // Gray-700
  border: '#1f2937',      // Gray-800
  background: '#030712',  // Gray-950
};
